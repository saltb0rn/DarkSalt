<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-10-19 周一 09:45 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Continuation Passing Style</title>
<meta name="generator" content="Org mode">
<meta name="author" content="saltb0rn">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"> -->
<meta name="referrer" content="same-origin">
<link rel="stylesheet" type="text/css" href="../../../css/stylesheet.css"/>
<link rel="icon" type="image/png" href="../../../img/icon.png" />
<!-- <script type="text/javascript" src="../../../js/live.js" defer></script> -->
<script src="../../../js/main.js" defer></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
    <nav>
        <a href="../../../"><img src="../../../img/logo.png" alt="Logo is on the way"/></a>
        <ul>
            <li><a accesskey="H" href="../../../"> Home </a></li>
            <li><a accesskey="T" href="../../../tags"> Tags </a></li>
            <li><a accesskey="A" href="../../../about"> About </a></li>
            <li><a accesskey="L" href="../../../todos"> Todos </a></li>
        </ul>
    </nav>
</div>
<div id="content">
<h1 class="title">Continuation Passing Style</h1>
<div class="abstract" id="org82a6ae0">
<p>
写一写自己对 <code>CPS</code> 的理解,个人经历有限,难免会有错误或者认识不全,所以请见谅.
</p>

</div>

<pre class="example" id="orga306d2c">
更新于 2018-11-12
</pre>

<div id="outline-container-org7045d64" class="outline-2">
<h2 id="org7045d64">偶遇 CPS</h2>
<div class="outline-text-2" id="text-org7045d64">
<p>
有很久一段时间没有写 <code>Python</code> 了,语法虽好,不过语法糖实在太多,断断续续的接触了一段时间的 <code>Lisp</code>, 从一开始的 <code>Common Lisp</code>,到现在的 <code>Emacs Lisp</code> 和 <code>Racket</code>,经过这段洗礼以后,有一种"不写 <code>Python</code> 了,干脆写 <code>Lisp</code> 为生算了"的想法(不过想生活的话,还是写 <code>Python</code> 靠谱点,都学就最好),我不是 <code>Lisp</code> 的佼佼者,不过应该也算是个 <code>Lisp fanboy</code> 了吧.
</p>

<p>
之所以学 <code>Lisp</code> 是因为当时看了王垠的博客而有了想去了解 <code>Programming Language</code> 的欲望.刚好前一段时间大概的读了 <code>Semantics Engineering</code> 和 <code>EOPL 3rd</code>,对这一块有一个大概的了解.目前还在补 EOPL 上的习题,这本书上有一个我挺感兴趣的内容,看到目录上有这个的时候我当场就兴奋不已,"终于找到有讲这一块的书了","这一块"就是 <code>Continuation Passing Style</code>,简称 <code>CPS</code>.
</p>
</div>
</div>


<div id="outline-container-org134d8c6" class="outline-2">
<h2 id="org134d8c6">Continuation</h2>
<div class="outline-text-2" id="text-org134d8c6">
<p>
在讲什么是 <code>CPS</code> 之前,得先说一下什么是 <code>continuation</code>.
</p>

<p>
在 <code>Lisp</code> 的方言之一 <code>Racket</code> 的里面,它是一个特性,记录下计算过程中的某个执行点的上下文.
</p>

<p>
接下来我会用 <code>Racket</code> 来讲解,放心,我会简单地讲一下要用到的一些 <code>forms</code>,不会真的涉及到 <code>Racket</code> 的 <code>continuation</code> 的实际操作,只是讲它的意像.
</p>
</div>

<div id="outline-container-orga7e1b8d" class="outline-3">
<h3 id="orga7e1b8d">简单的 Lisp</h3>
<div class="outline-text-3" id="text-orga7e1b8d">
<p>
<code>Racket</code> 里面一般是这样定义函数的,以定义一个形式参数为 <code>a</code> 和 <code>b</code> 的整型加法函数 <code>add</code> ,和一个减法函数 <code>sub</code> 为例子.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add</span> a b<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>+ a b<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">sub</span> a b<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>- a b<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#21487;&#20197;&#21033;&#29992;lambda&#34920;&#36798;&#24335;&#23450;&#20041;&#20989;&#25968;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define add (lambda (a b) (+ a b)))</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 1 and 2, then returns 3 as the result</span>
<span style="color: #DCDCCC;">(</span>add 1 2<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 3 and 2, then returns 1 as the result</span>
<span style="color: #DCDCCC;">(</span>sub 3 2<span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">if condition then true-branch else false-branch</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span>&gt; <span style="color: #D0BF8F;">(</span>sub 3 2<span style="color: #D0BF8F;">)</span> 0<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>sub 3 2<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>add 1 2<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
上面注释的 <code>lambda</code> 表达式绑定给 <code>add</code> 函数,而 <code>lambda</code> 表达式就像是匿名函数,反映了 <code>Racket</code> 支持函数式编程.简单点说就是过程与数据有着同等地位,这个特性后面会用上.
</p>

<p>
接下来用一个更复杂的例子,定义一个名为 <code>ans</code> 的函数,接收三个整型形参 <code>x,y,z</code> 返回结果为 <code>(add (sub x y) z)</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">ans</span> x y z<span style="color: #BFEBBF;">)</span>
   <span style="color: #BFEBBF;">(</span>add <span style="color: #D0BF8F;">(</span>sub x y<span style="color: #D0BF8F;">)</span> z<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgd541826" class="outline-3">
<h3 id="orgd541826">控制上下文(Control context)</h3>
<div class="outline-text-3" id="text-orgd541826">
<p>
好了,介绍什么是 <code>continuation</code> 之前先介绍一下什么是控制上下文?首先要先了解什么是上下文,所谓上下文就是贯穿整个过程的一个意像,在整个过程中的每一个点上,上下文的状态都不一样.
</p>

<p>
而控制上下文就像 <code>stack</code>,假如调用 <code>(ans 1 2 3)</code>,那么会发生以下几件事情,
</p>

<ol class="org-ol">
<li>形式参数和实际参数发生绑定: <code>x=1, y=2, z=3</code>.</li>

<li>计算 <code>(sub x y)</code>, 结果为 <code>-1</code>.</li>

<li>计算 <code>(add 1 3)</code>, 结果为 <code>2</code>.</li>
</ol>

<p>
整一个计算过程需要记住变量的值,这需要一个叫做 <code>environment</code> 的东西进行储存,它就是一个从变量到值的映射, <code>environment</code> 是数据上下文(data context)的一个抽象.
</p>

<p>
除了数据上下文,还有另外一种上下文,上面的整个计算过程中的第二步和第三步,每次执行一步都需要记录下一步要从哪里开始,这个就是所谓的控制上下文.事实上还可以想象一下用调试器的逐步调试的过程,每一步都是一个执行点,逐步执行直到计算结束.
</p>

<p>
而 <code>continuation</code> 就是控制上下文的一个抽象,它就像 <code>stack</code> 的帧(frame). <code>Environment</code> 是一个映射,它的 <code>representation</code> 有很多选择:哈希表,关联链表等等,那么 <code>continuation</code> 的 <code>representation</code> 又是什么呢?
</p>
</div>
</div>


<div id="outline-container-org8b816ef" class="outline-3">
<h3 id="org8b816ef">Continuation 的 representation</h3>
<div class="outline-text-3" id="text-org8b816ef">
<p>
在给 <code>continuation</code> 选择 <code>representation</code> 之前先给每一个执行点选择一种 <code>representation</code>.每一执行点相当于一个过程,每执行一个点就是一次调用.
</p>

<p>
比如调用 <code>(ans 1 2 3)</code>, 这样的话 <code>(sub 1 2)</code> 的结果 <code>-1</code>,不过 <code>-1</code> 不是一个过程,在 <code>Racket</code> 里面,一个函数(procedure here, not function)其实就是一个过程,所以这一步可以这样表示,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#19968;&#27493;,&#25226;&#31532;&#19968;&#27493;&#20445;&#23384;&#22312;first-step</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">first-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>pre-step-res<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>sub 1 2<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#19968;&#27493;&#30456;&#24403;&#20110;&#20197;&#19979;,void&#26159;Racket&#37324;&#38754;&#30340;&#19968;&#20010;&#20540;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res1</span> <span style="color: #BFEBBF;">(</span>first-step void<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
第二步需要等待第一步的运算结果,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#20108;&#27493;,&#25226;&#31532;&#20108;&#27493;&#20445;&#23384;&#22312;second-step</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">second-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>pre-step-res<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>add pre-step-res 3<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#20108;&#27493;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res2</span> <span style="color: #BFEBBF;">(</span>second-step res1<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
最后一步就是返回上一步的结果做为整个计算的返回值,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">last-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>v<span style="color: #D0BF8F;">)</span> v<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
除了用函数作为 <code>representation</code> 外,还可以选择数据结构作为 <code>representation</code>,这个数据结构包含了下一步需要的信息,比如 <code>environment</code>, <code>expression</code>, <code>value</code>, <code>procedure</code> 和 <code>continuation</code>.
</p>

<p>
其中 <code>expression</code> 是下一个要执行的表达式, <code>environment</code> 就是该 <code>expression</code> 执行的 <code>environment</code>, <code>continuation</code> 就是该 <code>expression</code> 的 <code>continuation</code>,如此类推.
</p>

<p>
我想你应该多少能看出来了这是一个递归.下面开始演示如何编写 <code>CPS</code> 程序.
</p>
</div>
</div>
</div>


<div id="outline-container-org9246dd6" class="outline-2">
<h2 id="org9246dd6">Continuation Passing Style</h2>
<div class="outline-text-2" id="text-org9246dd6">
</div>
<div id="outline-container-org4bb284b" class="outline-3">
<h3 id="org4bb284b">什么是 CPS</h3>
<div class="outline-text-3" id="text-org4bb284b">
<p>
顾名思意, <code>CPS</code> 就是一种风格,这种风格就是把 <code>continuation</code> 作为参数传递.类似的还有 <code>Environment Passing Style</code>.
</p>

<p>
用这个参数记录运行时的内容.
</p>
</div>
</div>


<div id="outline-container-orgb3dfa1d" class="outline-3">
<h3 id="orgb3dfa1d">CPS 的意义</h3>
<div class="outline-text-3" id="text-orgb3dfa1d">
<p>
其实就是对控制上下文(control context)进行抽象和实例化以及把递归转化成尾递归.
</p>

<p>
对控制上下文进行抽象就是说程序执行的下一步可以被抽象成数据表示,就像上面的说明例子那样,就是使用了函数来表示下一步要执行的动作.
</p>

<p>
然后就是能够把递归变成尾递归,在支持尾递归优化的语言中是可以获得优化的.
</p>
</div>
</div>


<div id="outline-container-org19d16b6" class="outline-3">
<h3 id="org19d16b6">把上面的 ans 改写成 CPS 程序 ans/k</h3>
<div class="outline-text-3" id="text-org19d16b6">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">ans/k</span> x y z cont<span style="color: #BFEBBF;">)</span>
   <span style="color: #BFEBBF;">(</span>sub/k x y
      <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>res1<span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>add/k res1 z
            <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>res2<span style="color: #94BFF3;">)</span>
               <span style="color: #94BFF3;">(</span>cont res2<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
这是这个例子的最终结果.现在开始说改写的思路,也就是一套把程序转换 <code>CPS</code> 程序的算法.
</p>
</div>
</div>


<div id="outline-container-org1e77d9f" class="outline-3">
<h3 id="org1e77d9f">Simple Expression and Tail Form Expression</h3>
<div class="outline-text-3" id="text-org1e77d9f">
<p>
要转变成 <code>CPS</code>,则要理解 <code>CPS</code> 对表达式做出的划分: <code>SimpleExp</code> 以及 <code>TfExp</code> (Tail Form Expression).
</p>

<p>
<code>SimpleExp</code> 包括常量以及变量: <code>1</code>, <code>a</code>, <code>(- 2 x)</code>, <code>(lambda (v) v)</code> 以及 <code>(zero? x)</code> 等等
<code>TfExp</code> 则是由 <code>SimpleExp</code> 组合而成的复杂表达式(<code>ComplexExp</code>), 有: <code>(f x)</code>, <code>(if (exp1) exp2 exp3)</code> 等等.
由于 <code>TfExp</code> 是可以拆分成多个 <code>SimpleExp</code> 的,而 <code>SimpleExp</code> 是不可再分的,所以 <code>SimpleExp</code> 也可以叫 <code>AtomicExp</code>.
</p>

<p>
关系大致就像这样:
</p>

<div class="org-src-container">
<pre class="src src-example">SimpleExp    ::= Constant || Variable
TfExp        ::= (SimpleExp SimpleExp*)
</pre>
</div>

<p>
这样就可以保证 <code>TfExp</code> 处于函数的 <code>tail position</code>, <code>tail position</code> 就是函数的退出的位置,也就是结束的地方,
</p>

<p>
这一步的 <code>continuation</code> 和整个函数的 <code>continuation</code> 是一样的,也就是说栈空间没有发生改变,在这种地方的调用就是尾调用(tail call),这样的函数称为 <code>tail form</code> 的.
</p>
</div>
</div>


<div id="outline-container-orga5378a7" class="outline-3">
<h3 id="orga5378a7">一套把程序转化为 CPS 程序的算法</h3>
<div class="outline-text-3" id="text-orga5378a7">
<p>
先示范如何把 <code>ans</code> 改写成 <code>CPS</code>,也就是把表达式改写成 <code>TfExp</code>.
</p>

<ol class="org-ol">
<li>把 <code>(ans x y z)</code> 改写 <code>(ans/k x y z cont)</code>,</li>

<li>在 <code>(ans x y z)</code> 整个的计算过程里面, <code>(sub x y)</code> 是第一个进行运算的,同时它也是一个 <code>non-simple expression</code>,所以先对它的调用进行改写, <code>(sub/k x y cont1)</code>, <code>cont1</code> 就是要执行的下一步,</li>

<li>计算完 <code>(sub x y)</code>,下一步就是计算整个结果了,假设上一步的 <code>(sub x y)</code> 的结果为 <code>res1</code>,那么下一步就是 <code>(add res1 z)</code> 的计算了, 它及是第二个 <code>non-simple expression</code>, 对它进行改写 <code>(add/k res1 z cont2)</code>,</li>

<li><p>
回到 <code>cont1</code> 和 <code>cont2</code> 上,在第2步上面说到 <code>cont1</code> 是下一步,而 <code>(add res1 z)</code> 刚好也是 <code>(sub x y)</code> 的下一步,那么 <code>cont1</code> 就是 <code>(lambda (res1) (add res1 z))</code>,不要忘记把 <code>(add res1 z)</code> 改写成 <code>(add/k res1 z cont2)</code>;
</p>

<p>
<code>cont2</code> 就是 <code>(add res1 z)</code> 的下一步,它的下一步就是返回结果,假设 <code>(add res1 z)</code> 的结果为 <code>res2</code>,那么 <code>cont2</code> 就是 <code>(lambda (res2) res2)</code>?,不,这是错的!正确是 <code>(lambda (res2) (cont res2))</code>,不要忘记了 <code>(ans/k x y z cont)</code> 里面的 <code>cont</code>,
</p>

<p>
这是才是整个计算过程的真正最后一步,这一步也是什么都没有做,就是返回结果,所以它应该是这样的 <code>(lambda (res) res)</code>,这也被叫做空延续.
</p></li>

<li><p>
最后还要把 <code>add</code> 和 <code>sub</code> 的定义也要改写,注意 <code>+</code> 和 <code>-</code> 是 <code>primitive operators</code>,不能对它们的定义进行修改,所以它们就不用改写,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add/k</span> x y cont<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>cont <span style="color: #D0BF8F;">(</span>+ x y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">sub/k</span> x y cont<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>cont <span style="color: #D0BF8F;">(</span>- x y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div></li>
</ol>


<p>
<code>CPS</code> 的程序实际上反映了这程序的计算过程,这一步到下一步,如此类推,直到计算完毕.
</p>


<p>
<code>EOPL</code> 中有一段 <code>The CPS Recipe</code> 有对这套算法进行总结,内容大概如下:
</p>

<ol class="org-ol">
<li>把每个子程序的定义需要多一个参数,这个参数表示的是 <code>continuation</code>, 一般叫做 <code>cont</code> 或者 <code>k</code>;</li>
<li>当子程序的返回值是常量或者变量 <code>v</code>,都要改成返回 <code>continuation</code> 的返回值,也就是 <code>(cont v)</code> 或者 <code>(k v)</code>;</li>
<li>当一个子程序的调用 <code>(proc x)</code> 出现在 <code>tail position</code>,也就是子程序返回的地方,那么改成就使用同一个 <code>cont</code> 来调用函数, <code>(proc x cont)</code>;</li>
<li>当一个子程序的调用 <code>(proc x)</code> 出现在 <code>operand position</code>,也就是参数位置,比如 <code>(operator (proc x))</code>, 那么先要在一个新的 <code>continuation</code> 下运算完这个调用,
给它的运算结果一个名字,比如 <code>v1,v2...</code>, 并且继续计算.</li>
</ol>

<p>
书中的例子还是很经典的,所以就抄下来了:
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #F0DFAF; font-weight: bold;">#lang</span> racket

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>x<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>zero? x<span style="color: #93E0E3;">)</span> 17<span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>f x<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 2<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>+ 22 <span style="color: #9FC59F;">(</span>f x<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 3<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>g 22 <span style="color: #9FC59F;">(</span>f x<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 4<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>+ <span style="color: #9FC59F;">(</span>f x<span style="color: #9FC59F;">)</span> 33 <span style="color: #9FC59F;">(</span>g y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #93E0E3;">(</span>h <span style="color: #9FC59F;">(</span>f x<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>- 44 y<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>g y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">after transforming</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>x cont<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>zero? x<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>cont 17<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>f x cont<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 2<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>f x
        <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>v<span style="color: #94BFF3;">)</span>
           <span style="color: #94BFF3;">(</span>+ 22 v<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 3<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>f x
        <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>v<span style="color: #94BFF3;">)</span>
           <span style="color: #94BFF3;">(</span>g 22 v cont<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= x 4<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>f x
        <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>v1<span style="color: #94BFF3;">)</span>
           <span style="color: #94BFF3;">(</span>g y
              <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #8FB28F;">(</span>v2<span style="color: #8FB28F;">)</span>
                 <span style="color: #8FB28F;">(</span>cont <span style="color: #6CA0A3;">(</span>+ v1 33 v2<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #93E0E3;">(</span>f x
             <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>v1<span style="color: #94BFF3;">)</span>
                <span style="color: #94BFF3;">(</span>g y
                   <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #8FB28F;">(</span>v2<span style="color: #8FB28F;">)</span>
                      <span style="color: #8FB28F;">(</span>h v1 <span style="color: #6CA0A3;">(</span>- 44 y<span style="color: #6CA0A3;">)</span> v2 cont<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
正如上面的代码所展示一样,一旦把子程序转化成 <code>CPS</code>,里面调用的所有子程序都要对应的变化成 <code>CPS</code>.
</p>
</div>
</div>


<div id="outline-container-org9197b92" class="outline-3">
<h3 id="org9197b92">最后一个例子</h3>
<div class="outline-text-3" id="text-org9197b92">
<p>
分别定义累加从1到n的函数 <code>bad-acc,acc-tail和acc</code>, 以及(Fibonacci) <code>bad-fib</code> 和 <code>fib</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #F0DFAF; font-weight: bold;">#lang</span> racket
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">require</span> racket/trace<span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bad acc</span>
<span style="color: #DCDCCC;">(</span>trace-define <span style="color: #BFEBBF;">(</span>bad-acc n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        0
        <span style="color: #D0BF8F;">(</span>+ n <span style="color: #93E0E3;">(</span>bad-acc <span style="color: #9FC59F;">(</span>- n 1<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">tail form</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc-tail</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>acc-tail-inner n 0<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>trace-define <span style="color: #BFEBBF;">(</span>acc-tail-inner n res<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        res
        <span style="color: #D0BF8F;">(</span>acc-tail-inner <span style="color: #93E0E3;">(</span>- n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>+ res n<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>acc/k n <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>val<span style="color: #93E0E3;">)</span> val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>trace-define <span style="color: #BFEBBF;">(</span>acc/k n cont<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>cont 0<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>acc/k <span style="color: #93E0E3;">(</span>- n 1<span style="color: #93E0E3;">)</span>
               <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>res<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>cont <span style="color: #94BFF3;">(</span>+ n res<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">BONUS: even tail form can be convert into cps</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc-tail-inner/k</span> n res cont<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>cont res<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>acc-tail-inner/k
          <span style="color: #93E0E3;">(</span>- n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>+ res n<span style="color: #93E0E3;">)</span> cont<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">bad fib</span>
<span style="color: #DCDCCC;">(</span>trace-define <span style="color: #BFEBBF;">(</span>bad-fib n<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">or</span> <span style="color: #93E0E3;">(</span>= n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>= n 2<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      1
      <span style="color: #D0BF8F;">(</span>+ <span style="color: #93E0E3;">(</span>bad-fib <span style="color: #9FC59F;">(</span>- n 2<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>bad-fib <span style="color: #9FC59F;">(</span>- n 1<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps</span>
<span style="color: #DCDCCC;">(</span>trace-define <span style="color: #BFEBBF;">(</span>fib/k n cont<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">or</span> <span style="color: #93E0E3;">(</span>= n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>= n 2<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>cont 1<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>fib/k
       <span style="color: #93E0E3;">(</span>- n 2<span style="color: #93E0E3;">)</span>
       <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>res1<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>fib/k
          <span style="color: #94BFF3;">(</span>- n 1<span style="color: #94BFF3;">)</span>
          <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #E0CF9F;">(</span>res2<span style="color: #E0CF9F;">)</span>
            <span style="color: #E0CF9F;">(</span>cont <span style="color: #8FB28F;">(</span>+ res1 res2<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">fib</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>fib/k n <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>val<span style="color: #93E0E3;">)</span> val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">tests</span>
<span style="color: #DCDCCC;">(</span>bad-acc 10<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>acc-tail 10<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>acc 10<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>bad-fib 7<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>fib 7<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
利用 <code>racket/trace</code> 中的 <code>trace</code> 跟踪计算过程,会发现在3者中, <code>acc-tail</code> 和 <code>acc</code> 的计算行为和迭代是一样的,对于 <code>bad-acc</code>,可以明显观察到每一步,并且有明显的起伏.
</p>

<p>
这是因为 <code>Racket</code> 支持尾递归优化,把尾递归优化成迭代,显然 <code>bad-acc</code> 没能优化成功.
</p>

<p>
这下面是计算时候的进出栈的变化,可以看到 <code>bad-acc</code> 以及 <code>fib</code> 的栈深是先增长后缩小.
</p>

<p>
而经过 <code>cps</code> 转换的则是栈深没有发生任何改变.
</p>

<div class="org-src-container">
<pre class="src src-sh">Welcome to Racket v7.5.
racket@&gt; ,enter <span style="color: #CC9393;">"/home/saltb0rn/.config/emacs/site-lisp/test.rkt"</span>
&gt;(bad-acc 10)
&gt; (bad-acc 9)
&gt; &gt;(bad-acc 8)
&gt; &gt; (bad-acc 7)
&gt; &gt; &gt;(bad-acc 6)
&gt; &gt; &gt; (bad-acc 5)
&gt; &gt; &gt; &gt;(bad-acc 4)
&gt; &gt; &gt; &gt; (bad-acc 3)
&gt; &gt; &gt; &gt; &gt;(bad-acc 2)
&gt; &gt; &gt; &gt; &gt; (bad-acc 1)
&gt; &gt; &gt; &gt;[10] (bad-acc 0)
&lt; &lt; &lt; &lt;[10] 0
&lt; &lt; &lt; &lt; &lt; 1
&lt; &lt; &lt; &lt; &lt;3
&lt; &lt; &lt; &lt; 6
&lt; &lt; &lt; &lt;10
&lt; &lt; &lt; 15
&lt; &lt; &lt;21
&lt; &lt; 28
&lt; &lt;36
&lt; 45
&lt;55
55
&gt;(acc-tail-inner 10 0)
&gt;(acc-tail-inner 9 10)
&gt;(acc-tail-inner 8 19)
&gt;(acc-tail-inner 7 27)
&gt;(acc-tail-inner 6 34)
&gt;(acc-tail-inner 5 40)
&gt;(acc-tail-inner 4 45)
&gt;(acc-tail-inner 3 49)
&gt;(acc-tail-inner 2 52)
&gt;(acc-tail-inner 1 54)
&gt;(acc-tail-inner 0 55)
&lt;55
55
&gt;(acc/k 10 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:78:13&gt;)</span>
&gt;(acc/k 9 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 8 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 7 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 6 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 0 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&lt;55
55
&gt;(bad-fib 7)
&gt; (bad-fib 5)
&gt; &gt;(bad-fib 3)
&gt; &gt; (bad-fib 1)
&lt; &lt; 1
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&lt; &lt;2
&gt; &gt;(bad-fib 4)
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&lt; &lt;3
&lt; 5
&gt; (bad-fib 6)
&gt; &gt;(bad-fib 4)
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&lt; &lt;3
&gt; &gt;(bad-fib 5)
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&gt; &gt; (bad-fib 4)
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 3)
&gt; &gt; &gt; (bad-fib 1)
&lt; &lt; &lt; 1
&gt; &gt; &gt; (bad-fib 2)
&lt; &lt; &lt; 1
&lt; &lt; &lt;2
&lt; &lt; 3
&lt; &lt;5
&lt; 8
&lt;13
13
&gt;(fib/k 7 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:112:13&gt;)</span>
&gt;(fib/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 6 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&lt;13
13
racket@test.rkt&gt; 
</pre>
</div>

<p>
和前面三个函数的迭代计算行为不一样, <code>Fibonacci</code> 的计算行为是树形递归,同样可以通过 <code>CPS</code> 得到优化.
</p>

<p>
仔细看你会发现 <code>acc-tail-inner/k</code> 的 <code>cont</code> 是多余的,在实际开发中如果遇到尾递归的话可以绕路不写,因为那样意义不大,因为 <code>CPS</code> 的其中一个目的就是为了保证尾递归的发生,就没必要改成 <code>CPS</code> 了.
</p>

<p>
<code>CPS</code> 只能保证尾调用,像在 <code>Python</code> 和 <code>Emacs Lisp</code> 这种有”先天缺陷“ (不支持尾递归优化 Tail Call Optimization, abbr. TCO) 的语言中,尾递归也不能解决爆栈的问题,
</p>

<p>
不过既然改成 <code>CPS</code> 了,那就很容易地把 <code>CPS</code> 转化成迭代/循环,并且 <code>Python</code> 和 <code>Emacs Lisp</code> 这些语言都有循环语句.
</p>
</div>
</div>
</div>


<div id="outline-container-org84800f6" class="outline-2">
<h2 id="org84800f6">Trampoline 和 Bounce</h2>
<div class="outline-text-2" id="text-org84800f6">
<pre class="example" id="orgb605158">
写于 2019/4/8
</pre>

<p>
<code>Python</code> 和 <code>Emacs Lisp</code> 这类语言之所以会因为递归而爆栈,归根到底是因为这些语言中函数会发生多次不返回的调用(就是没来得及返回就开始新的调用).
</p>

<p>
这个时候直译器就会在每次调用的时候记录下函数的调用状态和其他信息,这个时候栈就会一直上涨,在不加以限制的情况下,若递归逻辑出错就会引发崩溃.
</p>

<p>
而如果语言支持尾递归优化,那么函数的调用状态信息就会只进栈一次,递归过程中只是修改栈上的状态信息,和迭代一样,就和上面 <code>Racket</code> 的 <code>acc</code> 例子一样.
</p>

<p>
既然函数调用会压栈,那么在函数调用链增长的时候断开一下就好了,而且尾递归优化的语言中尾递归和迭代效率一样,那就 <b>把尾递归改成迭代</b>.
</p>

<p>
为此我们需要一个叫做 <code>Trampoline</code> 的 <code>continuation</code> "调度器" (毕竟和事件循环挺像的) 以及一个叫做 <code>bounce</code> 对象, 该对象 <b>包含上一步的计算结果和下一步的 <code>continuation</code></b>.
</p>

<p>
比如我们把上面的 <code>acc/k</code> 改写成可以供 <code>Trampoline</code> 使用的形式,也就是把 <code>acc/k</code> 改成 <code>bounce</code> 版本 <code>acc-bounce</code>.
</p>

<p>
为了断开函数调用链,我们需要 <b>把 <code>acc/k</code> 中所有的尾调用换成 <code>bounce</code> 值,也就是说把返回值需要变为 <code>bounce</code></b> ,这是使用 <code>Trampoline</code> 技术的关键.
</p>

<p>
(至于 <code>Fibonacci</code> 的,这里只给出 <code>Racket</code> 版本,一是为了优先专注于简单的 <code>acc-bounce</code>,二是我懒)
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bounce &#30340;&#23450;&#20041;,</span>
<span style="color: #DCDCCC;">(</span>struct bounce <span style="color: #BFEBBF;">(</span>res cont<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23545; acc/k &#36827;&#34892;&#20462;&#25913;,&#35201;&#28857;&#20043;&#19968;&#23601;&#26159;&#25226;&#25152;&#26377; acc/k &#30340;&#35843;&#29992;(&#20063;&#23601;&#26159;&#36820;&#22238;&#20540;)&#25442;&#25104;bounce&#20540;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21487;&#20197;&#36825;&#20040;&#24819;,&#36825;&#20040;&#20570;&#26159;&#25226;&#21407;&#26412;&#30340;&#35843;&#29992;&#32473;&#25286;&#24320;&#20102;.</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc-bounce</span> n cont<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>bounce 0 cont<span style="color: #D0BF8F;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (cont 0), &#30452;&#25509;&#25286;</span>
      <span style="color: #D0BF8F;">(</span>bounce n       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (acc-bounce (- n 1) (lambda (res) (cont (+ n res)))), &#36825;&#37324;&#25286;&#30340;&#22320;&#26041;&#26159; (cont (+ n res)),</span>
              <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>t<span style="color: #9FC59F;">)</span>  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21644; (cont 0) &#19981;&#19968;&#26679;,&#36825;&#20010;&#38656;&#35201;&#20808;&#25226; n &#30452;&#25509;&#25552;&#21040;&#22806;&#38754;&#28982;&#21518;&#24471;&#21040;&#19968;&#20010;&#26032;&#30340; continuation: (lambda (t) (acc-bounce (- t 1) (cont (+ t res)))), &#26368;&#21518;&#25286; (cont (+ t res)) &#21464;&#25104; (bounce (+ t res) cont)</span>
                <span style="color: #9FC59F;">(</span>acc-bounce <span style="color: #94BFF3;">(</span>- t 1<span style="color: #94BFF3;">)</span>
                            <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #E0CF9F;">(</span>res<span style="color: #E0CF9F;">)</span> <span style="color: #E0CF9F;">(</span>bounce <span style="color: #8FB28F;">(</span>+ t res<span style="color: #8FB28F;">)</span> cont<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30001;&#20110; Racket &#27809;&#26377;&#20160;&#20040;&#31867;&#20284;&#19982; Python while statement &#37027;&#31181;&#19996;&#35199;,&#25152;&#20197;&#25105;&#36824;&#26159;&#29992;&#20102;&#36882;&#24402;,&#22312; Python &#20013;&#21487;&#20197;&#25913;&#20889;&#25104; while</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">fib-bounce</span> n cont<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">or</span> <span style="color: #93E0E3;">(</span>= n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>= n 2<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>bounce 1 cont<span style="color: #D0BF8F;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (cont 0), &#30452;&#25509;&#25286;</span>
      <span style="color: #D0BF8F;">(</span>bounce n       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#25286;&#24320;&#31532;&#19968;&#20010;&#35843;&#29992; (fib/k (- n 2) ...)</span>
              <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>t<span style="color: #9FC59F;">)</span>
                <span style="color: #9FC59F;">(</span>fib-bounce
                 <span style="color: #94BFF3;">(</span>- t 2<span style="color: #94BFF3;">)</span>
                 <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #E0CF9F;">(</span>res1<span style="color: #E0CF9F;">)</span>
                   <span style="color: #E0CF9F;">(</span>bounce  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#25286;&#24320;&#31532;&#20108;&#20010;&#35843;&#29992; (fib/k (-n 1) ...),&#36825;&#37324;&#20854;&#23454;&#21487;&#20197;&#19981;&#25286;,</span>
                    <span style="color: #8FB28F;">(</span>- t 1<span style="color: #8FB28F;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#36807;&#20026;&#20102;&#21644;&#25226;&#23614;&#35843;&#29992;&#25442;&#25104;bounce&#30340;&#35828;&#27861;&#20445;&#25345;&#19968;&#33268;,&#24212;&#35813;&#25286;&#24320;</span>
                    <span style="color: #8FB28F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #6CA0A3;">(</span>t1<span style="color: #6CA0A3;">)</span>
                      <span style="color: #6CA0A3;">(</span>fib-bounce
                       t1
                       <span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>res2<span style="color: #BFEBBF;">)</span>
                         <span style="color: #BFEBBF;">(</span>bounce <span style="color: #D0BF8F;">(</span>+ res1 res2<span style="color: #D0BF8F;">)</span> cont<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#26368;&#21518;&#19968;&#27425;&#25286;&#24320;</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">trampoline</span>
  <span style="color: #BFEBBF;">[</span>lambda <span style="color: #D0BF8F;">(</span>b<span style="color: #D0BF8F;">)</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">let* &#25805;&#20316;&#31526;&#21487;&#20197;&#26242;&#26102;&#29702;&#35299;&#20026;&#20854;&#23427;&#35821;&#35328;&#20013;&#30340;&#23616;&#37096;&#23450;&#20041;</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">kont = bounce-cont(b)</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">n    = bounce-res(b)</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">res  = kont(n)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>kont <span style="color: #94BFF3;">(</span>bounce-cont b<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
           <span style="color: #9FC59F;">[</span>n <span style="color: #94BFF3;">(</span>bounce-res b<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
           <span style="color: #9FC59F;">[</span>res <span style="color: #94BFF3;">(</span>kont n<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span>bounce? res<span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span>trampoline res<span style="color: #9FC59F;">)</span>
          res<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">]</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>trampoline <span style="color: #BFEBBF;">(</span>acc-bounce 10000000 <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>x<span style="color: #93E0E3;">)</span> x<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>

<span style="color: #BFEBBF;">(</span>trampoline <span style="color: #D0BF8F;">(</span>fib-bounce 7 <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>x<span style="color: #9FC59F;">)</span> x<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
</pre>
</div>

<p>
由于 <code>Racket</code> 本身就支持尾递归优化,所以上面的代码其实只要能保证尾递归就能用的了,根本不需要确保 <code>bounce</code> 版的 <code>acc/k</code> 去掉所有调用.
</p>

<p>
接下来,我会按照这段代码的思路用 <code>Python</code> 和 <code>JavaScript</code> 实现一边,这两门语言都是不支持尾递归优化的.
</p>

<p>
貌似默认最大递归层数都为一千(<code>Python</code> 确定, <code>JavaScript</code> 没说),如果上面的方法能行那么突破了限制的的计算规模就可以通过计算了.
</p>

<p>
<code>Python</code> 版本:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Bounce</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">self</span>, res, cont<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">self</span>.res = res
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">self</span>.cont = cont


<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">trampoline</span><span style="color: #DCDCCC;">(</span>bounce<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">while</span> 1:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">res</span> = bounce.cont<span style="color: #DCDCCC;">(</span>bounce.res<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #DCDCCC; font-weight: bold;">isinstance</span><span style="color: #DCDCCC;">(</span>res, Bounce<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">bounce</span> = res
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> res


<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">acc_bounce</span><span style="color: #DCDCCC;">(</span>n, cont<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">if</span> n == 0:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> Bounce<span style="color: #DCDCCC;">(</span>n, cont<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">kont</span><span style="color: #DCDCCC;">(</span>t<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> acc_bounce<span style="color: #DCDCCC;">(</span>t-1, <span style="color: #F0DFAF; font-weight: bold;">lambda</span> res: Bounce<span style="color: #BFEBBF;">(</span>t+res, cont<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">return acc_bounce(t-1, lambda res: cont(t+res)) # &#36825;&#26679;&#20381;&#28982;&#20250;&#29190;&#26632;,&#20063;&#23601;&#26159;&#25105;&#19978;&#38754;&#35828;&#30340;&#19968;&#23450;&#35201;&#25226;&#25152;&#26377;&#35843;&#29992;&#25442;&#25104; bounce</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> Bounce<span style="color: #DCDCCC;">(</span>n, kont<span style="color: #DCDCCC;">)</span>


<span style="color: #DFAF8F;">bounce</span> = acc_bounce<span style="color: #DCDCCC;">(</span>50000, <span style="color: #F0DFAF; font-weight: bold;">lambda</span> x: x<span style="color: #DCDCCC;">)</span>  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#25105;&#20915;&#23450;&#32473;&#20010;50000&#36816;&#31639;&#35268;&#27169;</span>
<span style="color: #F0DFAF; font-weight: bold;">print</span><span style="color: #DCDCCC;">(</span>trampoline<span style="color: #BFEBBF;">(</span>bounce<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
我还发现有一个更加高级的实现方法,直接对 <code>AST</code> 实现变换: <a href="https://github.com/0x65/trampoline">https://github.com/0x65/trampoline</a>.
</p>

<p>
<code>JavaScript</code> 版本:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">trampoline</span>(<span style="color: #DFAF8F;">bounce</span>) {
    <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">res</span>;
    <span style="color: #F0DFAF; font-weight: bold;">while</span> (1) {
        res = bounce.cont(bounce.res);
        <span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">typeof</span>(res) == <span style="color: #CC9393;">'object'</span>)
            bounce = res;
        <span style="color: #F0DFAF; font-weight: bold;">else</span>
            <span style="color: #F0DFAF; font-weight: bold;">return</span> res;
    }
}

<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">accBounce</span>(<span style="color: #DFAF8F;">n</span>, <span style="color: #DFAF8F;">cont</span>) {
    <span style="color: #F0DFAF; font-weight: bold;">if</span> (n == 0) {
        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
            res: n,
            cont: cont
        };
    } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
            res: n,
            <span style="color: #93E0E3;">cont</span>: <span style="color: #F0DFAF; font-weight: bold;">function</span>(<span style="color: #DFAF8F;">t</span>) {
                <span style="color: #F0DFAF; font-weight: bold;">return</span> accBounce(
                    t-1,
                    res =&gt; {
                        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
                            cont: cont,
                            res: t+res
                        };
                    });
            }
        };
    }
}

console.log(trampoline(accBounce(50000, x =&gt; x)));
</pre>
</div>
</div>

<div id="outline-container-org8c04a9c" class="outline-3">
<h3 id="org8c04a9c">Emacs Lisp 突破 Fibonacci 的递归限制</h3>
<div class="outline-text-3" id="text-org8c04a9c">
<p>
个人也还挺喜欢 <code>Emacs Lisp</code>,所以展示一个在 <code>Emacs Lisp</code> 下的 <code>fib</code> 逐渐改成 <code>fib-bounce</code> 的过程.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bounce</span>
(<span style="color: #F0DFAF; font-weight: bold;">defstruct</span> (bounce
            (<span style="color: #DCDCCC; font-weight: bold;">:constructor</span> nil)
            (<span style="color: #DCDCCC; font-weight: bold;">:constructor</span> bounce (res cont)))
  res cont)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">tampoline</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">tampoline</span> (b)
  (<span style="color: #F0DFAF; font-weight: bold;">let*</span> ((kont (bounce-cont b))
         (val (bounce-res b))
         (res (funcall kont val)))
    (<span style="color: #F0DFAF; font-weight: bold;">while</span> (bounce-p res)
      (<span style="color: #F0DFAF; font-weight: bold;">setq</span>
       kont (bounce-cont res)
       val (bounce-res res)
       res (funcall kont val)))
    res))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24120;&#35268;&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib</span> (n)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      1
    (+ (fib (- n 2)) (fib (- n 1)))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib/k</span> (n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (funcall cont 1)
    (fib/k (- n 2)
           (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
             (fib/k (- n 1)
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
                      (funcall cont (+ res1 res2))))))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22522;&#20110;cps&#25913;&#20889;&#30340;bounce&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib-bounce</span> (n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (bounce 1 cont)
    (bounce n
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t1)
              (fib-bounce
               (- t1 2)
               (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
                 (bounce
                  (- t1 1)
                  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t2)
                    (fib-bounce
                     t2
                     (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
                       (bounce (+ res1 res2) cont)))))))))))

(fib 1000) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30452;&#25509;&#25253;&#38169;: Lisp nesting exceeds &#8216;</span><span style="color: #BFEBBF;">max-lisp-eval-depth</span><span style="color: #7F9F7F;">&#8217;</span>
(tampoline (fib-bounce 1000 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) v))) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#38656;&#35201;&#24456;&#38271;&#26102;&#38388;&#26469;&#24471;&#20986;&#35745;&#31639;&#32467;&#26524;,&#20294;&#26159;&#19981;&#20250;&#35302;&#21457;&#36882;&#24402;&#38480;&#21046;&#32780;&#25253;&#38169;</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org5f7a455" class="outline-2">
<h2 id="org5f7a455">结语</h2>
<div class="outline-text-2" id="text-org5f7a455">
<p>
还是觉得这篇东西有很多地方有欠缺,也说明了我对 <code>CPS</code> 的理解还不够深入.突然觉得 <code>EOPL</code> 写的很好,因为我能明白给我传达的知识,原来写一篇易懂的科普文是如此艰难,真的是佩服这些老前辈.
</p>

<p>
<code>EOPL</code> 这本书都写到了这些内容,个人十分推荐去阅读这本书,总的来说, <code>CPS</code> 可以保证尾递归发生,而 <code>Trampoline</code> 可以保证不支持尾递归的语言运行尾递归不会发生爆栈,也就是说这两项技术可以实现尾递归优化,用在直译器上面就不言而喻了.
</p>

<p>
最后给出别的一些文章作为参考资料: <a href="http://matt.might.net/articles/cps-conversion/">http://matt.might.net/articles/cps-conversion/</a>,顺便推荐一下 <code>Matt Might</code> 的博客(也就是推荐文章的出处),内容都十分不错,基本都是和 <code>PLT</code> 相关的,有兴趣的可以看一下.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: saltb0rn (<a href="mailto:asche34@outlook.com">asche34@outlook.com</a>)</p>
<p class="date">Date: 2018-06-20</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.4)</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
