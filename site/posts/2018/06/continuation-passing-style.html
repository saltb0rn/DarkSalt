<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-11-12 Mon 18:51 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Continuation Passing Style</title>
<meta name="generator" content="Org mode">
<meta name="author" content="saltb0rn">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../../css/stylesheet.css"/>
<link rel="icon" type="image/png" href="../../../img/icon.png" />
<script type="text/javascript" src="../../../js/live.js" defer></script>
<script src="../../../js/main.js" defer></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
    <nav>
        <a href="/"><img src="../../../img/logo.png" alt="Logo is on the way"/></a>
        <ul>
            <li><a accesskey="H" href="/"> Home </a></li>
            <li><a accesskey="T" href="/tags"> Tags </a></li>
            <li><a accesskey="A" href="/about"> About </a></li>
        </ul>
    </nav>
</div>
<div id="content">
<h1 class="title">Continuation Passing Style</h1>
<div class="abstract">
<p>
写一写自己对 <code>CPS</code> 的理解,个人经历有限,难免会有错误或者认识不全,所以请见谅.
</p>

</div>

<pre class="example">
更新于 2018-11-12
</pre>

<div id="outline-container-org8b44c00" class="outline-2">
<h2 id="org8b44c00">偶遇 CPS</h2>
<div class="outline-text-2" id="text-org8b44c00">
<p>
有很久一段时间没有写 <code>Python</code> 了,语法虽好,不过语法糖实在太多,断断续续的接触了一段时间的 <code>Lisp</code>, 从一开始的 <code>Common Lisp</code>,到现在的 <code>Emacs Lisp</code> 和 <code>Racket</code>,经过这段洗礼以后,有一种"不写 <code>Python</code> 了,干脆写 <code>Lisp</code> 为生算了"的想法(不过想生活的话,还是写 <code>Python</code> 靠谱点,都学就最好),我不是 <code>Lisp</code> 的佼佼者,不过应该也算是个 <code>Lisp fanboy</code> 了吧.
</p>

<p>
之所以学 <code>Lisp</code> 是因为当时看了王垠的博客而有了想去了解 <code>Programming Language</code> 的欲望.刚好前一段时间大概的读了 <code>Semantics Engineering</code> 和 <code>EOPL 3rd</code>,对这一块有一个大概的了解.目前还在补 EOPL 上的习题,这本书上有一个我挺感兴趣的内容,看到目录上有这个的时候我当场就兴奋不已,"终于找到有讲这一块的书了","这一块"就是 <code>Continuation Passing Style</code>,简称 <code>CPS</code>.
</p>
</div>
</div>


<div id="outline-container-org3e4e231" class="outline-2">
<h2 id="org3e4e231">Continuation</h2>
<div class="outline-text-2" id="text-org3e4e231">
<p>
在讲什么是 <code>CPS</code> 之前,得先说一下什么是 <code>continuation</code>.
</p>

<p>
在 <code>Lisp</code> 的方言之一 <code>Racket</code> 的里面,它是一个特性,记录下计算过程中的某个执行点的上下文.
</p>

<p>
接下来我会用 <code>Racket</code> 来讲解,放心,我会简单地讲一下要用到的一些 <code>forms</code>,不会真的涉及到 <code>Racket</code> 的 <code>continuation</code> 的实际操作,只是讲它的意像.
</p>
</div>

<div id="outline-container-orgb67c3a6" class="outline-3">
<h3 id="orgb67c3a6">简单的 Lisp</h3>
<div class="outline-text-3" id="text-orgb67c3a6">
<p>
<code>Racket</code> 里面一般是这样定义函数的,以定义一个形式参数为 <code>a</code> 和 <code>b</code> 的整型加法函数 <code>add</code> ,和一个减法函数 <code>sub</code> 为例子.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add</span> a b<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>+ a b<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">sub</span> a b<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>- a b<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#21487;&#20197;&#21033;&#29992;lambda&#34920;&#36798;&#24335;&#23450;&#20041;&#20989;&#25968;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define add (lambda (a b) (+ a b)))</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 1 and 2, then returns 3 as the result</span>
<span style="color: #DCDCCC;">(</span>add 1 2<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 3 and 2, then returns 1 as the result</span>
<span style="color: #DCDCCC;">(</span>sub 3 2<span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">if condition then true-branch else false-branch</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span>&gt; <span style="color: #D0BF8F;">(</span>sub 3 2<span style="color: #D0BF8F;">)</span> 0<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>sub 3 2<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>add 1 2<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
上面注释的 <code>lambda</code> 表达式绑定给 <code>add</code> 函数,而 <code>lambda</code> 表达式就像是匿名函数,反映了 <code>Racket</code> 支持函数式编程.简单点说就是过程与数据有着同等地位,这个特性后面会用上.
</p>

<p>
接下来用一个更复杂的例子,定义一个名为 <code>ans</code> 的函数,接收三个整型形参 <code>x,y,z</code> 返回结果为 <code>(add (sub x y) z)</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">ans</span> x y z<span style="color: #BFEBBF;">)</span>
   <span style="color: #BFEBBF;">(</span>add <span style="color: #D0BF8F;">(</span>sub x y<span style="color: #D0BF8F;">)</span> z<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org67f4291" class="outline-3">
<h3 id="org67f4291">控制上下文(Control context)</h3>
<div class="outline-text-3" id="text-org67f4291">
<p>
好了,介绍什么是 <code>continuation</code> 之前先介绍一下什么是控制上下文?首先要先了解什么是上下文,所谓上下文就是贯穿整个过程的一个意像,在整个过程中的每一个点上,上下文的状态都不一样.
</p>

<p>
假如调用 <code>(ans 1 2 3)</code>,那么会发生以下几件事情,
</p>

<ol class="org-ol">
<li>形式参数和实际参数发生绑定: <code>x=1, y=2, z=3</code>.</li>

<li>计算 <code>(sub x y)</code>, 结果为 <code>-1</code>.</li>

<li>计算 <code>(add 1 3)</code>, 结果为 <code>2</code>.</li>
</ol>

<p>
整一个计算过程需要记住变量的值,这需要一个叫做 <code>environment</code> 的东西进行储存,它就是一个从变量到值的映射, <code>environment</code> 是数据上下文(data context)的一个抽象.
</p>

<p>
除了数据上下文,还有另外一种上下文,上面的整个计算过程中的第二步和第三步,每次执行一步都需要记录下一步要从哪里开始,这个就是所谓的控制上下文.可以想象一下用调试器的逐步调试的过程,每一步都是一个执行点,逐步执行直到计算结束.
</p>

<p>
而 <code>continuation</code> 就是控制上下文的一个抽象. <code>Environment</code> 是一个映射,它的 <code>representation</code> 有很多选择:哈希表,关联链表等等,那么 <code>continuation</code> 的 <code>representation</code> 又是什么呢?
</p>
</div>
</div>


<div id="outline-container-org9e4cdb3" class="outline-3">
<h3 id="org9e4cdb3">Continuation 的 representation</h3>
<div class="outline-text-3" id="text-org9e4cdb3">
<p>
在给 <code>continuation</code> 选择 <code>representation</code> 之前先给每一个执行点选择一种 <code>representation</code>.每一执行点相当于一个过程,每执行一个点就是一次调用.
</p>

<p>
比如调用 <code>(ans 1 2 3)</code>, 这样的话 <code>(sub 1 2)</code> 的结果 <code>-1</code>,不过 <code>-1</code> 不是一个过程,在 <code>Racket</code> 里面,一个函数(procedure here, not function)其实就是一个过程,所以这一步可以这样表示,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#19968;&#27493;,&#25226;&#31532;&#19968;&#27493;&#20445;&#23384;&#22312;first-step</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">first-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>pre-step-res<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>sub 1 2<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#19968;&#27493;&#30456;&#24403;&#20110;&#20197;&#19979;,void&#26159;Racket&#37324;&#38754;&#30340;&#19968;&#20010;&#20540;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res1</span> <span style="color: #BFEBBF;">(</span>first-step void<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
第二步需要等待第一步的运算结果,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#20108;&#27493;,&#25226;&#31532;&#20108;&#27493;&#20445;&#23384;&#22312;second-step</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">second-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>pre-step-res<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>add pre-step-res 3<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#20108;&#27493;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res2</span> <span style="color: #BFEBBF;">(</span>second-step res1<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
最后一步就是返回上一步的结果做为整个计算的返回值,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">last-step</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>v<span style="color: #D0BF8F;">)</span> v<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
而 <code>continuation</code> 就是某个执行点的下一个执行点的打包,我想你应该多少能看出来了这是一个递归.下面开始演示如何编写 <code>CPS</code> 程序.
</p>
</div>
</div>
</div>


<div id="outline-container-orgc169afb" class="outline-2">
<h2 id="orgc169afb">Continuation Passing Style</h2>
<div class="outline-text-2" id="text-orgc169afb">
<p>
顾名思意, <code>CPS</code> 就是一种风格,这种风格就是把 <code>continuation</code> 作为参数传递.类似的还有 <code>Environment Passing Style</code>.
</p>
</div>

<div id="outline-container-org375e1cc" class="outline-3">
<h3 id="org375e1cc">CPS 的意义</h3>
<div class="outline-text-3" id="text-org375e1cc">
<p>
讨论它的意义实际上就是讨论为什么需要控制上下文,因为在直译器中,异常,线程这些语言特性是需要通过切换上下文来实现的,而数据上下文只能维护数据绑定.
</p>

<p>
除此以外我想不到还有什么意义,硬要说的话那就是编写 <code>CPS</code> 程序的时候可以像平常那样自然的思考: <b>做完这件事情后下一步要做什么</b>.
</p>
</div>
</div>


<div id="outline-container-orgc4e0c9b" class="outline-3">
<h3 id="orgc4e0c9b">把上面的 ans 改写成 CPS 程序 ans/k</h3>
<div class="outline-text-3" id="text-orgc4e0c9b">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">ans/k</span> x y z cont<span style="color: #BFEBBF;">)</span>
   <span style="color: #BFEBBF;">(</span>sub/k x y
      <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>res1<span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>add/k res1 z
            <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>res2<span style="color: #94BFF3;">)</span>
               <span style="color: #94BFF3;">(</span>cont res2<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
是不是有点看不懂?没事,看不懂是正常的,因为我前面只是说了 <code>continuation</code> 的概念而已,现在才是开始.来说说改写的思路,也就是一套把程序转换 <code>CPS</code> 程序的算法.
</p>
</div>
</div>


<div id="outline-container-org1868fac" class="outline-3">
<h3 id="org1868fac">Simple Expression and Non-simple Expression</h3>
<div class="outline-text-3" id="text-org1868fac">
<p>
首先需要把一个计算过程划分成若干个执行点,划分方案很多,可以直接把一个计算过程做为一个单独的点,不过这么就没有意义了.所以需要一套标准: 根据 <code>Simple expression</code> 和 <code>non-simple expression</code> 划分.
</p>

<p>
它们两者的关系就是 <code>non-simple expression</code> 由一到多个 <code>simple expression(s)</code> 组成.而写CPS程序的时候有点像整理出所有 <code>simple expressions</code> ,然后按照对应的顺序把它组合起来.
</p>

<p>
<code>Simple expression</code> 有点像 <code>straight-line code</code>,整个计算里面最基本的,不可再划分的一个单位: 函数,常量, <code>primitive operators(+,-,*,/,%等,不同语言会不同)</code> 和语言自带的 <code>operators</code> 的调用都是 <code>simple expression</code>.
</p>

<p>
<b>(其实 <code>EOPL</code> 上不是这么说的,它说是 <code>"guaranteed to never contain any procedure call"</code> ,因为实际中是没有办法把这些语言已经定义好的东西进行改写的,所以我就把自带的 <code>operators</code> 的调用也划分到 <code>simple expression</code> 里面了,请见谅)</b>
</p>

<p>
举几个例子.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>val<span style="color: #BFEBBF;">)</span> val<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>val<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>x<span style="color: #93E0E3;">)</span> x<span style="color: #D0BF8F;">)</span> val<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>+ 1 2<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>- 2 3<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>+ 1 <span style="color: #BFEBBF;">(</span>- 2 3<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
-
+
1
'x
null
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">or</span> 1 2<span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
<code>Non-simple expression</code> 就是 <code>simple expression</code> 以外的情况: <code>procedure call</code> 和条件语句,举几个例子,
</p>

<p>
<b>(和上面一样,某些调用并非 <code>non-expression</code> ,我个人把条件语句和用户定义的函数的 <code>procedure call</code> 归类到 <code>non-simple expression</code> 里面)</b>
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span>null? null<span style="color: #BFEBBF;">)</span> 1 2<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>x<span style="color: #D0BF8F;">)</span> x<span style="color: #BFEBBF;">)</span> 1<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>+ 1 <span style="color: #BFEBBF;">(</span>- 2 <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>x<span style="color: #9FC59F;">)</span> x<span style="color: #93E0E3;">)</span> 1<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
这样划分的原因是,可以保证 <code>non-simple expression</code> 处于函数的 <code>tail position</code>, <code>tail position</code> 就是函数的退出的位置,也就是结束的地方,这一步的 <code>continuation</code> 和整个函数的 <code>continuation</code> 是一样的,也就是说栈空间没有发生改变,在这种地方的调用就是尾递归调用(tail call),这样的函数称为 <code>tail form</code> 的.
</p>

<p>
简单点,就是保证了尾递归的发生.这里可能会有点绕,一时间可能会不太理解,具体可以结合之后的 <b>最后一个例子</b> 来理解.
</p>
</div>
</div>


<div id="outline-container-orga970d5e" class="outline-3">
<h3 id="orga970d5e">一套把程序转化为 CPS 程序的算法</h3>
<div class="outline-text-3" id="text-orga970d5e">
<p>
其实 <code>EOPL</code> 里一句就可以总结完了,找到第一个 <code>non-simple expression</code> 并且把它改写成 <code>CPS</code> ,对于剩下的 <code>non-simple expression</code> 重复这个过程.实际中细节还不少.在上面 <code>ans</code> 的例子中,
</p>

<ol class="org-ol">
<li>把 <code>(ans x y)</code> 改写 <code>(ans/k x y z cont)</code>,</li>

<li>找到第一个 <code>non-simple expression</code> 是 <code>(add x y)</code> ,于是对它进行改写 <code>(add/k x y cont)</code>,</li>

<li>在 <code>(add/k x y cont)</code> 中, <code>cont</code> 就是下一步计算过程,所以 <code>cont</code> 要改为 <code>(lambda (res1) (cont (sub res1 z)))</code>,</li>

<li>不过 <code>(sub res1 z)</code> 同样也是 <code>non-simple expression</code> ,于是改写为 <code>(sub/k res1 z cont)</code>,这里的 <code>cont</code> 就有点微妙了,写成 <code>(lambda (res2) (cont res2))</code>,</li>

<li><p>
最后还要把 <code>add</code> 和 <code>sub</code> 的定义也要改写,注意 <code>+</code> 和 <code>-</code> 是 <code>primitive operators</code>,不能对它们的定义进行修改,所以它们就不用改写.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add/k</span> x y cont<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>cont <span style="color: #D0BF8F;">(</span>+ x y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">sub/k</span> x y cont<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>cont <span style="color: #D0BF8F;">(</span>- x y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div></li>
</ol>

<p>
其实这个过程可以想的更加抽象一点, <code>CPS</code> 就是把多个简单的计算过程组合成一个复杂的计算过程.计算这一步,得出的结果传递给下一步并且开始计算,如此类推,直到计算完毕.
</p>
</div>
</div>


<div id="outline-container-org87fb914" class="outline-3">
<h3 id="org87fb914">最后一个例子</h3>
<div class="outline-text-3" id="text-org87fb914">
<p>
分别定义累加从1到n的函数 <code>bad-acc,acc-tail和acc</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bad acc</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">bad-acc</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        0
        <span style="color: #D0BF8F;">(</span>+ n <span style="color: #93E0E3;">(</span>bad-acc <span style="color: #9FC59F;">(</span>- n 1<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">tail form</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc-tail</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>acc-tail-inner n 0<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc-tail-inner</span> n res<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        res
        <span style="color: #D0BF8F;">(</span>acc-tail-inner <span style="color: #93E0E3;">(</span>- n 1<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>+ res n<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc</span> n<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span>acc/k n <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>val<span style="color: #93E0E3;">)</span> val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">acc/k</span> n cont<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>= n 0<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>cont 0<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>acc/k <span style="color: #93E0E3;">(</span>- n 1<span style="color: #93E0E3;">)</span>
               <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>res<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>cont <span style="color: #94BFF3;">(</span>+ n res<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
注意这个例子里面, <code>acc</code> 内部调用 <code>acc/k</code> 时候传入了 <code>(lambda (val) val)</code>,这表示一个空的 <code>continuation</code>.
</p>

<p>
利用 <code>racket/trace</code> 中的 <code>trace</code> 跟踪计算过程,会发现在3者中, <code>acc-tail</code> 和 <code>acc</code> 的计算行为是一样的,只有一步,对于 <code>bad-acc</code>,可以明显观察到每一步,并且有明显的起伏.
</p>

<p>
在 <code>Racket</code> 里面, <code>acc-tail</code> 和 <code>acc</code> 的计算行为和循环是一样的, <code>trace</code> 的跟踪都会只显示一步.所以我才觉得, <code>CPS</code> 是一门十分强大而优雅的"魔法".
</p>


<div class="figure">
<p><img src="../../../files/cps.jpg" alt="cps.jpg">
</p>
</div>

<p>
然而这门"魔法"不是万能的,如果把它用在像 <code>Python</code> 和 <code>Emacs Lisp</code> 这种有”先天缺“陷的语言上面就不行了.
</p>
</div>
</div>
</div>


<div id="outline-container-orgb25e9f0" class="outline-2">
<h2 id="orgb25e9f0">结语</h2>
<div class="outline-text-2" id="text-orgb25e9f0">
<p>
还是觉得这篇东西有很多地方有欠缺,也说明了我对 <code>CPS</code> 的理解还不够深入.突然觉得 <code>EOPL</code> 写的很好,因为我能明白给我传达的知识,原来写一篇易懂的科普文是如此艰难,真的是佩服这些老前辈.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_wrapper">
    <div id="disqus_thread"></div>
    <script>
     /**
      *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
     /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
      */
     let disqus;
     (function() { // DON'T EDIT BELOW THIS LINE
         var d = document;
         disqus = d.createElement('script');
         disqus.async = true;
         disqus.src = 'https://darksalt-me.disqus.com/embed.js';
         disqus.setAttribute('data-timestamp', +new Date());
         disqus.onload = function(){
             console.log("Load disqus successfully.");
         };
         disqus.onerror = function(){
             console.log("Load disqus failed.");
         };
         (d.head || d.body).appendChild(disqus);
     })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
<p class="author">Author: saltb0rn (<a href="mailto:asche34@outlook.com">asche34@outlook.com</a>)</p>
<p class="date">Date: 2018-06-20</p>
<p class="creator">Generated by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 25.2.2 (<a href="https://orgmode.org">Org</a> mode 9.1.14)</p>
</div>
</body>
</html>
