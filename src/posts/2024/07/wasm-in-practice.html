<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-07-19 Fri 13:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WASM实践</title>
<meta name="author" content="saltb0rn" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">WASM实践</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org477a4ca">1. "Easy Web Games in C" 的内容总结</a>
<ul>
<li><a href="#org18a3f67">1.1. 视频中遇到的问题</a>
<ul>
<li><a href="#orgdec9eda">1.1.1. clang 的 &#x2013;target 选项</a></li>
<li><a href="#org37de364">1.1.2. clang 编译优化会把没用上的 symbols 去掉</a></li>
<li><a href="#org57b9888">1.1.3. wasm-ld 的 &#x2013;allow-undefined 选项</a></li>
<li><a href="#org0d60f07">1.1.4. clang 的 -nostartfiles 选项的作用</a></li>
<li><a href="#orgcdd44c8">1.1.5. clang 的 &#x2013;sysroot 选项的作用</a></li>
<li><a href="#org2ba08ac">1.1.6. wasm-ld: error: cannot open crt1.o: No such file or directory</a></li>
</ul>
</li>
<li><a href="#orge4fdb7f">1.2. 观后感</a></li>
</ul>
</li>
<li><a href="#org0cdf8ab">2. mini-wasm-lib workshop</a></li>
<li><a href="#org2ba307b">3. 学习 raylib 的 WASM 编译</a>
<ul>
<li><a href="#org8296187">3.1. 常见问题</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="abstract" id="orgd90cd83">
<p>
在去年通过阅读 <code>The Art Of WebAssembly</code> 学习 <code>WebAssembly</code> (简称 <code>WASM</code>) 之后基本上再无使用过 <code>WASM</code> 了,
</p>

<p>
这本书算得上是一本不错的 <code>WASM</code> 入门书, 偏向 <code>WASM</code> 的底层, 但关于实际开发的内容很少.
</p>

<p>
这本书也有介绍到 <code>Emscripten</code> 这种使用的工具链, 我也尝试过这个工具, 不过这个工具用起来有一种很难受的感觉:
</p>

<p>
告诉你只需要那么做, 这么做就可以了, 把里面重要的细节都藏起来了.
</p>

<p>
这样会出现一个问题: <code>Emscripten</code> 就像是针对各种各样的问题提供了对应的解决方案, 只要你遇到了这些问题, 直接按照它提供的方案即可;
</p>

<p>
然而, 实际开发的问题远远不止这些, 要能够解决这些问题就得自己动手给出解决方案.
</p>

<p>
发现了这个真相后我就失望的中断了 <code>WASM</code> 的实践学习.
</p>

<p>
正如所有的计算机问题一样, 只要了解底层原理的人才有创造解决方案的能力.
</p>

<p>
这几天有幸逛到 <a href="https://www.youtube.com/watch?v=H_cnrhVYsK0&amp;t=1324s&amp;ab_channel=TsodingDaily">Tsoding 老哥的 Easy Web Games in C</a> 的视频, 视频内容就是在不依赖 <code>Emscripten</code> 的情况下把 <a href="https://github.com/raysan5/raylib">raylib</a> 程序移植到浏览器上;
</p>

<p>
他本人也是支持了解底层这个观点, 但同时也说了不是反对使用 <code>Emscripten</code>, 而是为了让自己拥有解决预想外问题的能力.
</p>

<p>
在看完他的视频后我重新燃起了探索的欲望, 因此, 这片文章是对 <code>Tsoding</code> 视频内容的整理以及拓展, 势必要在实际开发中掌握 <code>WASM</code> 的使用.
</p>

</div>

<div id="outline-container-org477a4ca" class="outline-2">
<h2 id="org477a4ca"><span class="section-number-2">1.</span> "Easy Web Games in C" 的内容总结</h2>
<div class="outline-text-2" id="text-1">
<blockquote>
<p>
这里我本人跟练的<a href="https://github.com/saltb0rn/easy-web-game-in-c">项目</a>, 和视频的会有些出入, 这是因为在跟练过程中冒出了一些想法.
</p>
</blockquote>

<p>
视频内容分三部分:
</p>

<p>
前期小部分演示了如何使用 <code>raylib</code> 写一个 <code>Linux</code> 版本的例子;
</p>

<p>
中期部分演示了如何按照 <code>raylib</code> 官方文档的指示使用 <code>Emscripten</code> 编译链接 <code>C</code> 源文件(<code>game.c</code>)和 <a href="https://github.com/raysan5/raylib/wiki/Working-for-Web-(HTML5)">wasm 版 raylib</a> 生成浏览器项目;
</p>

<p>
下半部分演示了用 <code>clang</code> 编译 <code>game.c</code> 得到 <code>game.wasm</code>, 但不让它和 <code>raylib</code> 进行连接,
</p>

<p>
然后使用 <code>JavaScript</code> 手动实现 <code>game.c</code> 所使用到的 <code>raylib API</code>, 提供给编译出来的 <code>game.wasm</code> 调用, 让项目最终运行起来.
</p>

<p>
这两种方法各有优劣:
</p>

<p>
使用 <code>Emscripten</code> 的优点是可以减少工作量,
</p>

<p>
缺点是需要对 <code>game.c</code> 进行改造成适用于浏览器的发布, 也就是说, 如果想让 <code>game.c</code> 发布到原生平台和浏览器, 那么你需要写两套代码;
</p>

<p>
另外一个缺点就是这个方式生成的 <code>wasm</code> 模块会相对较大, <code>raylib</code> 算是依赖较少的 <code>C</code> 库了, 实际开发中会有不少依赖复杂的库, 他们的 <code>wasm</code> 模块会异常大体积.
</p>

<blockquote>
<p>
其实有办法可以在不写两套 <code>C</code> 代码的情况下使用 <code>Emscripten</code> 生成项目.
</p>

<p>
不过, 这就违背了 <code>raylib</code> 文档中的 "Avoid raylib <code>while(!WindowShouldClose())</code> loop" 了,
</p>

<p>
这是因为浏览器采用了协作式多任务(<code>co-operative multitasking</code>)事件模型:
</p>

<p>
每个事件都有有一个回合(turn, 我这里就采用回合制游戏名词作为翻译)用来执行, 在执行完后把控制权交换给浏览器, 浏览器再把控制权交给另外一个事件.
</p>

<p>
这就是为什么在浏览器里面执行死循环会导致浏览器卡住, 因为死循环并没有执行完毕这一动作, 因此也没有把控制权交还给浏览器.
</p>

<p>
而 <code>while(!WindowShouldClose())</code> 编译成 <code>WASM</code> 后就是一个死循环.
</p>

<p>
当然官方也意识到了开发者可能无法避免使用 "<code>while(!WindowShouldClose())</code> loop", 因此给出了 <a href="https://kripken.github.io/blog/wasm/2019/07/16/asyncify.html">ASYNCIFY</a> 解决方案让代码以异步方式执行.
</p>
</blockquote>

<p>
而第二种方法: 手动实现 <code>raylib</code> 的 <code>API</code> 提供给 <code>game.wasm</code>, 优点则是不依赖复杂的工具链 <code>Emscripten</code>, <code>game.wasm</code> 体积小, 无须写两套 <code>game.c</code>,
</p>

<p>
缺点就是工作量大, 必须手动通过 <code>JavaScript</code> 实现一切使用到的 <code>raylib API</code> 和 <code>libc API</code>.
</p>

<blockquote>
<p>
这里引出一个思考: 什么要 <code>JavaScript</code> 去实现 <code>API</code> 提供给 <code>WASM</code> 呢? 为什么不直接在 <code>C</code> 里面实现呢?
</p>

<p>
其实要 <code>JavaScript</code> 有两种场景.
</p>

<p>
<code>Emscripten</code> 的 <code>GLFW API</code> 也是通过 <code>JavaScript</code> 实现的, 在浏览器上和绘制相关的问题基本上都是绕不开 <code>Canvas</code> 的,
</p>

<p>
而 <code>WASM</code> 是不能直接操作 <code>DOM</code> 的, 这部分功能 <b>只能</b> 在 <code>JavaScript</code> 进行封装, 并作为 <code>imports</code> 提供给 <code>WASM</code> 调用.
</p>

<p>
所以在实际开发中, 要识别哪些功能是绕不开浏览器的, 这些功能就 <code>JavaScript</code> 进行封装, 其他的尽量交给 <code>C</code> 来完成, 这就是第一种场景.
</p>

<p>
另外一种场景是想要手动连接 <code>WASM</code> 模块: 通过 <code>JavaScript</code> 实现 <code>WASM</code> 模块之间的依赖关系从而实现模块之间的连接.
</p>

<p>
第二种方法相当于手动链接 <code>game.wasm</code> 模块, 视频的例子是便于观众理解 <code>wasm</code> 在浏览器上从加载到连接再到调用一整套流程.
</p>

<p>
视频里还特别演示了 <code>game.wasm</code> 暴露的 <code>C</code> 函数的参数在 <code>JavaScript</code> 里面是怎么样的, 通过 <code>JavaScript</code> 实现这个函数要如何处理这些参数.
</p>
</blockquote>
</div>

<div id="outline-container-org18a3f67" class="outline-3">
<h3 id="org18a3f67"><span class="section-number-3">1.1.</span> 视频中遇到的问题</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgdec9eda" class="outline-4">
<h4 id="orgdec9eda"><span class="section-number-4">1.1.1.</span> clang 的 &#x2013;target 选项</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
使用 <code>clang</code> 编译 <code>WASM</code> 时, 需要设置 <code>--target</code> 选项为符合产生 <code>WASM</code> 的值, <code>--target</code> 值需要符合一种叫做 <a href="https://llvm.org/doxygen/Triple_8h_source.html">target triple</a> 的格式:
</p>

<pre class="example" id="org2e2cc74">
ARCHITECTURE-VENDOR-OPERATING_SYSTEM
ARCHITECTURE-VENDOR-OPERATING_SYSTEM-ENVIRONMENT
</pre>

<p>
参考源代码来讲:
</p>

<p>
<code>ARCHITECTURE</code> 的值是 <code>&lt;ArchType&gt;&lt;SubArchType&gt;</code>, 其中 <code>&lt;SubArchType&gt;</code> 在 <code>&lt;ArchType&gt;</code> 满足某些值的情况下才有;
<code>VERDOR</code> 的值是 <code>&lt;VendorType&gt;</code>;
<code>OPERATING_SYSTEM</code> 的值是 <code>&lt;OSType&gt;</code>;
<code>ENVIRONMENT</code> 的值是 <code>&lt;EnvironmentType&gt;</code>.
</p>

<blockquote>
<p>
<code>&lt;ENUM-NAME&gt;</code> 是 <code>C/C++</code> 中枚举类型的定义.
</p>
</blockquote>

<p>
视频中的 <code>--target</code> 是 <code>wasm32</code>, 相当于 <code>wasm32-unknow-unknow</code>;
</p>

<p>
由于我本人的代码中没有像视频中那样把 <code>math.h</code> 的 <code>API</code> 声明复制出来进行忽略, 而是使用 <code>wasi-libc</code> 进行连接(后面会提到),
</p>

<p>
所以我的 <code>--target</code> 是 <code>wasm32-unknown-wasi</code>, 目的是为了让 <code>wasm-ld</code> 方便的找到 <code>wasi-libc</code> 的头文件和库文件.
</p>

<p>
我的 <code>Makefile</code> 留了一个 <code>--target=wasm32</code> 的 <code>Makefile rule</code> 的注释, 该注释等同于 <code>--target=wasm32-unknown-wasi</code> 的 <code>Makefile rule</code>.
</p>
</div>
</div>

<div id="outline-container-org37de364" class="outline-4">
<h4 id="org37de364"><span class="section-number-4">1.1.2.</span> clang 编译优化会把没用上的 symbols 去掉</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
按照视频里面 <code>Makefile</code>,
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #87cefa;">game.wasm</span>: game.c
        clang --target=wasm32 -I./linux/include --no-standard-libraries -Wl,--no-entry -Wl,--allow-undefined -o game.wasm game.c
</pre>
</div>

<p>
我们实际编译出来的 <code>game.wasm</code> 所对应的 <code>wat</code> 是这样的:
</p>

<div class="org-src-container">
<pre class="src src-wat">(<span style="color: #00ffff;">module</span> <span style="color: #eedd82;">$game.wasm</span>
  (<span style="color: #00ffff;">table</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">0;)</span> 1 1 <span style="color: #98fb98;">funcref</span>)
  (<span style="color: #00ffff;">memory</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">0;)</span> 2)
  (<span style="color: #00ffff;">global</span> <span style="color: #eedd82;">$__stack_pointer</span> (<span style="color: #98fb98;">mut i32</span>) (<span style="color: #b0c4de;">i32.const</span> 66560))
  (<span style="color: #00ffff;">export</span> <span style="color: #ffa07a;">"memory"</span> (<span style="color: #00ffff;">memory</span> 0)))
</pre>
</div>

<p>
视频里面编译出来的结果 <b>大概</b> (本人没法保证完全一样)如下:
</p>

<div class="org-src-container">
<pre class="src src-wat">(<span style="color: #00ffff;">module</span> <span style="color: #eedd82;">$game.wasm</span>
  (<span style="color: #00ffff;">type</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">0;)</span> (<span style="color: #00ffff;">func</span> (<span style="color: #98fb98;">param i32 i32 i32</span>)))
  (<span style="color: #00ffff;">type</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">1;)</span> (<span style="color: #00ffff;">func</span> (<span style="color: #98fb98;">result i32</span>)))
  (<span style="color: #00ffff;">type</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">2;)</span> (<span style="color: #00ffff;">func</span>))
  (<span style="color: #00ffff;">type</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">3;)</span> (<span style="color: #00ffff;">func</span> (<span style="color: #98fb98;">param i32</span>)))
  (<span style="color: #00ffff;">type</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">4;)</span> (<span style="color: #00ffff;">func</span> (<span style="color: #98fb98;">param i32 i32</span>) (<span style="color: #98fb98;">result i32</span>)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"InitWindow"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$InitWindow</span> (<span style="color: #00ffff;">type</span> 0)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"WindowShouldClose"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$WindowShouldClose</span> (<span style="color: #00ffff;">type</span> 1)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"BeginDrawing"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$BeginDrawing</span> (<span style="color: #00ffff;">type</span> 2)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"ClearBackground"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$ClearBackground</span> (<span style="color: #00ffff;">type</span> 3)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"EndDrawing"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$EndDrawing</span> (<span style="color: #00ffff;">type</span> 2)))
  (<span style="color: #00ffff;">import</span> <span style="color: #ffa07a;">"env"</span> <span style="color: #ffa07a;">"CloseWindow"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$CloseWindow</span> (<span style="color: #00ffff;">type</span> 2)))
  (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$__original_main</span> (<span style="color: #00ffff;">type</span> 1) (<span style="color: #98fb98;">result i32</span>)
    (<span style="color: #00ffff;">local</span><span style="color: #98fb98;"> i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32 i32</span>)
    <span style="color: #b0c4de;">global.get</span> <span style="color: #eedd82;">$__stack_pointer</span>
    <span style="color: #b0c4de;">local.set</span> 0
    <span style="color: #b0c4de;">i32.const</span> 16
    <span style="color: #b0c4de;">local.set</span> 1
    <span style="color: #b0c4de;">local.get</span> 0
    <span style="color: #b0c4de;">local.get</span> 1
    <span style="color: #b0c4de;">i32.sub</span>
    <span style="color: #b0c4de;">local.set</span> 2
    <span style="color: #b0c4de;">local.get</span> 2
    <span style="color: #b0c4de;">global.set</span> <span style="color: #eedd82;">$__stack_pointer</span>
    <span style="color: #b0c4de;">i32.const</span> 0
    <span style="color: #b0c4de;">local.set</span> 3
    <span style="color: #b0c4de;">local.get</span> 2
    <span style="color: #b0c4de;">local.get</span> 3
    <span style="color: #b0c4de;">i32.store</span> <span style="color: #b0c4de;">offset=</span>12
    <span style="color: #b0c4de;">i32.const</span> 800
    <span style="color: #b0c4de;">local.set</span> 4
    <span style="color: #b0c4de;">i32.const</span> 450
    <span style="color: #b0c4de;">local.set</span> 5
    <span style="color: #b0c4de;">i32.const</span> 1024
    <span style="color: #b0c4de;">local.set</span> 6
    <span style="color: #b0c4de;">local.get</span> 4
    <span style="color: #b0c4de;">local.get</span> 5
    <span style="color: #b0c4de;">local.get</span> 6
    <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$InitWindow</span>
    <span style="color: #b0c4de;">block</span>  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">label = @1</span>
      <span style="color: #b0c4de;">loop</span>  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">label = @2</span>
        <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$WindowShouldClose</span>
        <span style="color: #b0c4de;">local.set</span> 7
        <span style="color: #b0c4de;">i32.const</span> -1
        <span style="color: #b0c4de;">local.set</span> 8
        <span style="color: #b0c4de;">local.get</span> 7
        <span style="color: #b0c4de;">local.get</span> 8
        <span style="color: #b0c4de;">i32.xor</span>
        <span style="color: #b0c4de;">local.set</span> 9
        <span style="color: #b0c4de;">i32.const</span> 1
        <span style="color: #b0c4de;">local.set</span> 10
        <span style="color: #b0c4de;">local.get</span> 9
        <span style="color: #b0c4de;">local.get</span> 10
        <span style="color: #b0c4de;">i32.and</span>
        <span style="color: #b0c4de;">local.set</span> 11
        <span style="color: #b0c4de;">local.get</span> 11
        <span style="color: #b0c4de;">i32.eqz</span>
        <span style="color: #b0c4de;">br_if</span> 1 <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">@1;)</span>
        <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$BeginDrawing</span>
        <span style="color: #b0c4de;">i32.const</span> 230
        <span style="color: #b0c4de;">local.set</span> 12
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 12
        <span style="color: #b0c4de;">i32.store8</span> <span style="color: #b0c4de;">offset=</span>8
        <span style="color: #b0c4de;">i32.const</span> 41
        <span style="color: #b0c4de;">local.set</span> 13
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 13
        <span style="color: #b0c4de;">i32.store8</span> <span style="color: #b0c4de;">offset=</span>9
        <span style="color: #b0c4de;">i32.const</span> 55
        <span style="color: #b0c4de;">local.set</span> 14
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 14
        <span style="color: #b0c4de;">i32.store8</span> <span style="color: #b0c4de;">offset=</span>10
        <span style="color: #b0c4de;">i32.const</span> 255
        <span style="color: #b0c4de;">local.set</span> 15
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 15
        <span style="color: #b0c4de;">i32.store8</span> <span style="color: #b0c4de;">offset=</span>11
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">i32.load</span> <span style="color: #b0c4de;">offset=</span>8 <span style="color: #b0c4de;">align=</span>1
        <span style="color: #b0c4de;">local.set</span> 16
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 16
        <span style="color: #b0c4de;">i32.store</span> <span style="color: #b0c4de;">offset=</span>4
        <span style="color: #b0c4de;">i32.const</span> 4
        <span style="color: #b0c4de;">local.set</span> 17
        <span style="color: #b0c4de;">local.get</span> 2
        <span style="color: #b0c4de;">local.get</span> 17
        <span style="color: #b0c4de;">i32.add</span>
        <span style="color: #b0c4de;">local.set</span> 18
        <span style="color: #b0c4de;">local.get</span> 18
        <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$ClearBackground</span>
        <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$EndDrawing</span>
        <span style="color: #b0c4de;">br</span> 0 <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">@2;)</span>
      <span style="color: #b0c4de;">end</span>
    <span style="color: #b0c4de;">end</span>
    <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$CloseWindow</span>
    <span style="color: #b0c4de;">i32.const</span> 0
    <span style="color: #b0c4de;">local.set</span> 19
    <span style="color: #b0c4de;">i32.const</span> 16
    <span style="color: #b0c4de;">local.set</span> 20
    <span style="color: #b0c4de;">local.get</span> 2
    <span style="color: #b0c4de;">local.get</span> 20
    <span style="color: #b0c4de;">i32.add</span>
    <span style="color: #b0c4de;">local.set</span> 21
    <span style="color: #b0c4de;">local.get</span> 21
    <span style="color: #b0c4de;">global.set</span> <span style="color: #eedd82;">$__stack_pointer</span>
    <span style="color: #b0c4de;">local.get</span> 19
    <span style="color: #b0c4de;">return</span>)
  (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$main</span> (<span style="color: #00ffff;">type</span> 4) (<span style="color: #98fb98;">param i32 i32</span>) (<span style="color: #98fb98;">result i32</span>)
    (<span style="color: #00ffff;">local</span><span style="color: #98fb98;"> i32</span>)
    <span style="color: #b0c4de;">call</span> <span style="color: #eedd82;">$__original_main</span>
    <span style="color: #b0c4de;">local.set</span> 2
    <span style="color: #b0c4de;">local.get</span> 2
    <span style="color: #b0c4de;">return</span>)
  (<span style="color: #00ffff;">table</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">0;)</span> 1 1 <span style="color: #98fb98;">funcref</span>)
  (<span style="color: #00ffff;">memory</span> <span style="color: #ff7f24;">(;</span><span style="color: #ff7f24;">0;)</span> 2)
  (<span style="color: #00ffff;">global</span> <span style="color: #eedd82;">$__stack_pointer</span> (<span style="color: #98fb98;">mut i32</span>) (<span style="color: #b0c4de;">i32.const</span> 66592))
  (<span style="color: #00ffff;">export</span> <span style="color: #ffa07a;">"memory"</span> (<span style="color: #00ffff;">memory</span> 0))
  (<span style="color: #00ffff;">export</span> <span style="color: #ffa07a;">"main"</span> (<span style="color: #00ffff;">func</span> <span style="color: #eedd82;">$main</span>))
  (<span style="color: #00ffff;">data</span> <span style="color: #eedd82;">$.rodata</span> (<span style="color: #b0c4de;">i32.const</span> 1024) <span style="color: #ffa07a;">"Hello, from WebAssembly\00"</span>))
</pre>
</div>

<p>
而实际中 <code>Makefile</code> 要这么写才能和视频中得到差不多一样的结果:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #87cefa;">game.wasm</span>: game.c
        clang --target=wasm32 -I./linux/include --no-standard-libraries -Wl,--no-entry -Wl,--allow-undefined -o game.wasm game.c -Wl,--export=main
</pre>
</div>

<p>
原因不明, 可能是编译器的版本不一样, 视频中用的是 <code>clang14</code>, 本人用的是 <code>clang18</code>.
</p>
</div>
</div>

<div id="outline-container-org57b9888" class="outline-4">
<h4 id="org57b9888"><span class="section-number-4">1.1.3.</span> wasm-ld 的 &#x2013;allow-undefined 选项</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
作用是告诉链接器保留未定义的符号(symbols)并不发出报错.
</p>

<p>
该选项在新版 <code>wasm-ld</code> 中已经是老选项了, 被 <code>--unresolved-symbols=ignore-all</code> 和 <code>--import-undefined</code> 等同了.
</p>
</div>
</div>

<div id="outline-container-org0d60f07" class="outline-4">
<h4 id="org0d60f07"><span class="section-number-4">1.1.4.</span> clang 的 -nostartfiles 选项的作用</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
因为 <code>wasm-ld</code> 使用了 <code>--no-entry</code> 选项, 所以 <code>game.wasm</code> 是没有入口(<code>_start</code>)的, 相当于 <code>C</code> 源代码没有 <code>main</code> 函数一样.
</p>

<p>
因此也不需要执行 <code>main</code> 函数前的初始化工作, <code>-nostartfiles</code> 选项就是告诉连接器不需要负责初始化工作的目标文件(比如下面会提到的 <code>ctr1.o</code>).
</p>
</div>
</div>

<div id="outline-container-orgcdd44c8" class="outline-4">
<h4 id="orgcdd44c8"><span class="section-number-4">1.1.5.</span> clang 的 &#x2013;sysroot 选项的作用</h4>
<div class="outline-text-4" id="text-1-1-5">
<p>
用来设置编译链接时查找头文件/库文件的根目录, 在 <code>Linux</code> 上默认的更目录是 <code>/usr</code>, 从 <code>/usr/lib</code> 查找库, 从 <code>/usr/include</code> 查找头文件,
</p>

<p>
<code>--sysroot=/tmp/wasi-libc</code> 则会让编译器/连接器从 <code>/tmp/wasi-libc/include</code> 和 <code>/tmp/wasi-libc/lib</code> 中找文件.
</p>

<p>
之所以用这个选项是因为我的 <code>game.c</code> 使用了 <code>libc</code> 的函数, <code>game.wasm</code> 需要连接 <code>WASM</code> 的 <code>libc</code>, 这些文件并非位于系统定义的目录中.
</p>

<blockquote>
<p>
<code>/tmp/wasi-libc</code> 是需要自己手动安装的,
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/WebAssembly/wasi-libc
<span style="color: #b0c4de;">cd</span> wasi-libc
make install <span style="color: #eedd82;">INSTALL_DIR</span>=/tmp/wasi-libc
</pre>
</div>
</blockquote>
</div>
</div>

<div id="outline-container-org2ba08ac" class="outline-4">
<h4 id="org2ba08ac"><span class="section-number-4">1.1.6.</span> wasm-ld: error: cannot open crt1.o: No such file or directory</h4>
<div class="outline-text-4" id="text-1-1-6">
<p>
原问题是出现在视频里面的(这里按照我的 <code>Makefile</code> 调整一下进行复现), <code>Makefile</code> 大概如下:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #87cefa;">game.wasm</span>: game.c
        clang \
        -v \
        <span style="color: #eedd82;">--target</span>=wasm32 \
        <span style="color: #eedd82;">--sysroot</span>=/tmp/wasi-libc \
        -Wl,--verbose \
        -I./wasm/include \
        -L./wasm/lib \
        -I/tmp/wasi-libc/include/wasm32-wasi \
        -L/tmp/wasi-libc/lib/wasm32-wasi \
        -o <span style="color: #87cefa;">$</span><span style="color: #7fffd4;">@</span> $<span style="color: #7fffd4;">^</span> \
        <span style="color: #ffa07a;">'-l:libraylib.a'</span> \
        -lm
</pre>
</div>

<p>
首先 <a href="https://en.wikipedia.org/wiki/Crt0">crt1.o</a> 用于可执行文件的连接, 负责可执行文件 <code>main</code> 函数在执行前的所有初始化工作.
</p>

<p>
问题在于连接器 <code>wasm-ld</code> 默认会在 <code>sysroot</code> 下的 <code>lib</code> 目录查找 <code>crt1.o</code>, <code>wasi-libc</code> 的 <code>crt1.o</code> 是位于 <code>/tmp/wasi-libc/lib/wasm32-wasi</code> 中.
</p>

<p>
解决这个问题有两个方法:
</p>

<ol class="org-ol">
<li><p>
给 <code>crt1.o</code> 建立一个软链接到 <code>sysroot</code> 的 <code>lib</code> 中:
</p>

<p>
<code>ln -sf /tmp/wasi-libc/lib/wasm32-wasi/crt1.o /tmp/wasi-libc/lib/crt1.o</code>.
</p></li>

<li>把 <code>--target</code> 设置为 <code>wasm32-unknown-wasi</code>, <code>wasm-ld</code> 便能准确定位到 <code>crt1.o</code>.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orge4fdb7f" class="outline-3">
<h3 id="orge4fdb7f"><span class="section-number-3">1.2.</span> 观后感</h3>
<div class="outline-text-3" id="text-1-2">
<p>
在看到视频里面 <code>Tsoding</code> 因为 <code>raylib</code> 依赖标准库里面的 <code>math.h</code> 让把 <code>math.h</code> 所有函数声明拷贝到 <code>game.c</code> 的时候,
</p>

<p>
我冒出了一个想法: 如何在不依赖 <code>Emscripten</code> 的情况下让 <code>WASM</code> 模块连接自己想要的库?
</p>

<p>
于是就以连接 <code>C</code> 标准库为目标进行检索, 一番折腾后才发现 <a href="https://wasi.dev/">WebAssembly System Interface</a> (简称 <code>WASI</code>), 提供了各种可用于 <code>WASM</code> 编译链接的目标文件(动态库/静态库), 这些目标文件提供了适用于浏览器以及浏览器以外的运行时的 <code>API</code>.
</p>

<p>
在前面设置好的 <code>sysroot</code> 的 <code>/tmp/wasi-libc/lib/wasm32-wasi</code> 可以看到各种目标文件, 这些目标文件不是 <code>ELF</code> 文件, 而是和 <code>game.wasm</code> 一样都是 <code>WebAssembly binary module</code>.
</p>


<div id="org4ab7d5e" class="figure">
<p><img src="../../../files/libc-file-type.png" alt="libc-file-type.png" />
</p>
<p><span class="figure-number">Figure 1: </span>原生 libc 目标文件的文件类型</p>
</div>


<div id="org69b0b6a" class="figure">
<p><img src="../../../files/wasi-libc-file-type.png" alt="wasi-libc-file-type.png" />
</p>
<p><span class="figure-number">Figure 2: </span>wasi-libc 目标文件的文件类型</p>
</div>

<p>
随后又冒出了一个想法: 如何自己手动"造出"这种 <code>WASM</code> 库?
</p>

<p>
答案就是文章的后半部分了.
</p>
</div>
</div>
</div>

<div id="outline-container-org0cdf8ab" class="outline-2">
<h2 id="org0cdf8ab"><span class="section-number-2">2.</span> mini-wasm-lib workshop</h2>
<div class="outline-text-2" id="text-2">
<p>
这部分将会开发一个名为 <code>mini-wasm-lib</code> 的 <code>WASM</code> 库, 就像 <code>raylib</code> 一样能够发布原生版本和 <code>WASM</code> 版本的静态库:
</p>

<p>
来探讨如何把 <code>C</code> 库构建成 <code>WASM</code> 库.
</p>

<p>
作为例子, 这个库必须非常简单, 有 4 个源文件(<code>lib{0,1,2,3}.c</code>)和 1 个头文件(<code>include/mini.h</code>):
</p>

<ul class="org-ul">
<li><p>
<code>lib0.c</code> 提供函数 <code>int add(int, int)</code> 的实现
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #98fb98;">int</span> <span style="color: #87cefa;">add</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">a</span>, <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">b</span>) {
  <span style="color: #00ffff;">return</span> a + b;
}
</pre>
</div></li>

<li><p>
<code>lib1.c</code> 提供函数 <code>int sub(int, int)</code> 的实现
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #98fb98;">int</span> <span style="color: #87cefa;">sub</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">a</span>, <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">b</span>) {
    <span style="color: #00ffff;">return</span> a - b;
}
</pre>
</div></li>

<li><p>
<code>lib2.c</code> 提供函数 <code>int mul(int, int)</code> 的实现
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #98fb98;">int</span> <span style="color: #87cefa;">mul</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">a</span>, <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">b</span>) {
  <span style="color: #00ffff;">return</span> a * b;
}
</pre>
</div></li>

<li><p>
<code>lib3.c</code> 提供函数 <code>float div(int, int)</code> 的实现
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #98fb98;">float</span> <span style="color: #87cefa;">div</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">a</span>, <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">b</span>) {
  <span style="color: #00ffff;">return</span> a * 1.0f / b;
}
</pre>
</div></li>

<li><p>
<code>include/mini.h</code> 是提供这些函数声明的头文件
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #b0c4de;">#if</span><span style="color: #b0c4de;">n</span><span style="color: #b0c4de;">def</span> MINI_H
<span style="color: #b0c4de;">#define</span> <span style="color: #eedd82;">MINI_H</span>

<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">add</span>(<span style="color: #98fb98;">int</span>, <span style="color: #98fb98;">int</span>);
<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">sub</span>(<span style="color: #98fb98;">int</span>, <span style="color: #98fb98;">int</span>);
<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">mul</span>(<span style="color: #98fb98;">int</span>, <span style="color: #98fb98;">int</span>);
<span style="color: #98fb98;">float</span> <span style="color: #87cefa;">div</span>(<span style="color: #98fb98;">int</span>, <span style="color: #98fb98;">int</span>);

<span style="color: #b0c4de;">#endif</span>
</pre>
</div></li>
</ul>


<p>
这个库会把 <code>lib{0,1,2,3}.c</code> 编译成 4 个目标文件 <code>lib{0,1,2,3}.o</code>, 使用 <code>llvm-ar</code> 把这些目标文件归成一个档: <code>libmini.a</code>.
</p>

<p>
这个档就是 <code>mini-wasm-lib</code> 发布的静态库文件了, 会发布两个版本: 原生和 <code>WASM</code>.
</p>

<p>
源代码很简单, 重点在于构建上, 所以 <code>Makefile</code> 才是重点:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #87cefa;">.PHONY</span>: clean

<span style="color: #eedd82;">CC</span> := clang
<span style="color: #eedd82;">AR</span> := llvm-ar
<span style="color: #eedd82;">OBJS</span> := lib0.o lib1.o lib2.o lib3.o
<span style="color: #eedd82;">TARGET</span> ?= NATIVE
<span style="color: #eedd82;">CFLAGS</span>   ?=
<span style="color: #eedd82;">LIB_ROOT</span> := lib
<span style="color: #eedd82;">LIB_DIR</span>  ?=

ifeq ($(<span style="color: #eedd82;">TARGET</span>), WASM)
        <span style="color: #eedd82;">CFLAGS</span>  = --target=wasm32-unknown-wasi
        <span style="color: #eedd82;">LIB_DIR</span> = $(<span style="color: #eedd82;">LIB_ROOT</span>)/wasm
else
        <span style="color: #eedd82;">CFLAGS</span>  =
        <span style="color: #eedd82;">LIB_DIR</span> = $(<span style="color: #eedd82;">LIB_ROOT</span>)/native
endif

<span style="color: #87cefa;">libmini.a</span>: $(<span style="color: #eedd82;">OBJS</span>)
        mkdir -p $(<span style="color: #eedd82;">LIB_DIR</span>)
        $(<span style="color: #eedd82;">AR</span>) rcs $(<span style="color: #eedd82;">LIB_DIR</span>)/<span style="color: #87cefa;">$</span><span style="color: #7fffd4;">@</span> $<span style="color: #7fffd4;">^</span>
        rm -rf $(<span style="color: #eedd82;">OBJS</span>)

<span style="color: #87cefa;">$(</span><span style="color: #87cefa;">OBJS</span><span style="color: #87cefa;">)</span>: %.o: %.c
        mkdir -p $(<span style="color: #eedd82;">LIB_DIR</span>)
        $(<span style="color: #eedd82;">CC</span>) $(<span style="color: #eedd82;">CFLAGS</span>) -c -o <span style="color: #87cefa;">$</span><span style="color: #7fffd4;">@</span> $<span style="color: #7fffd4;">^</span>

<span style="color: #87cefa;">clean</span>:
        rm -rf $(<span style="color: #eedd82;">LIB_ROOT</span>)
</pre>
</div>

<blockquote>
<p>
需要注意的是, 这里一整套工具连都是使用的 <code>LLVM</code> 的, 非 <code>Unix/GNU</code>.
</p>

<p>
用 <code>clang</code> 而不是 <code>cc/gcc</code>;
</p>

<p>
用 <code>llvm-ar</code> 而不是 <code>ar</code>;
</p>

<p>
用 <code>llvm-nm</code> 而不是 <code>nm</code>;
</p>

<p>
用 <code>llvm-stripe</code> 而不是 <code>stripe</code>;
</p>

<p>
用 <code>llvm-ranlib</code> 而不是 <code>ranlib</code>.
</p>
</blockquote>

<p>
构建原生静态库如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">make
</pre>
</div>

<p>
构建 <code>WASM</code> 静态库如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">make <span style="color: #eedd82;">TARGET</span>=WASM
</pre>
</div>

<p>
这就是不是用 <code>Emscripten</code> 构建 <code>WASM</code> 库的方法, 这个例子没有使用到任何第三方库,
</p>

<p>
如果要使用, 那么就得使用 <code>WASI</code> 或者自己按照制作该库的方法把第三方库编译成 <code>WASM</code> 库再进行连接.
</p>

<p>
<code>WASI</code> 的使用方法可以参考我的 <code>easy-web-game-in-c</code> 项目的 <code>game.wasm</code> 是如何连接 <code>wasi-libc</code> 的.
</p>
</div>
</div>

<div id="outline-container-org2ba307b" class="outline-2">
<h2 id="org2ba307b"><span class="section-number-2">3.</span> 学习 raylib 的 WASM 编译</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org8296187" class="outline-3">
<h3 id="org8296187"><span class="section-number-3">3.1.</span> 常见问题</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2024-07-16</p>
<p class="author">Author: saltb0rn</p>
<p class="date">Created: 2024-07-19 Fri 13:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
